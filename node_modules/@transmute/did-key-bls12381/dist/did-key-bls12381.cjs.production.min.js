"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var r,i=e(require("bs58")),t=require("@mattrglobal/bbs-signatures"),n=e(require("base64url")),o=require("@mattrglobal/bls12381-key-pair"),c=function(){try{return Promise.resolve(t.generateBls12381G1KeyPair()).then((function(e){return Promise.resolve(t.generateBls12381G2KeyPair()).then((function(r){return{bls12381G1KeyPair:{id:"",type:"Bls12381G1Key2020",controller:"",publicKeyBase58:i.encode(e.publicKey),privateKeyBase58:i.encode(e.secretKey)},bls12381G2KeyPair:{id:"",type:"Bls12381G2Key2020",controller:"",publicKeyBase58:i.encode(r.publicKey),privateKeyBase58:i.encode(r.secretKey)}}}))}))}catch(e){return Promise.reject(e)}};function s(){return(s=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var i=arguments[r];for(var t in i)Object.prototype.hasOwnProperty.call(i,t)&&(e[t]=i[t])}return e}).apply(this,arguments)}!function(e){e.G1="BLS12381_G1",e.G2="BLS12381_G2"}(r||(r={}));var l,a={Bls12381G1Key2020:r.G1,Bls12381G2Key2020:r.G2},u=function(e){var r={id:e.id,controller:e.controller,type:"JsonWebKey2020",publicKeyJwk:{kty:"EC",crv:a[e.type],x:n.encode(i.decode(e.publicKeyBase58))}};return e.privateKeyBase58&&(r.privateKeyJwk={kty:"EC",crv:a[e.type],x:n.encode(i.decode(e.publicKeyBase58)),d:n.encode(i.decode(e.privateKeyBase58))}),r},y=function(e){if("z"!==e[0])throw new Error('base58 encoded fingerprint must start with "z"');var r=i.decode(e.substring(1));if(234===r[0]&&1===r[1])return{bls12381G1KeyPair:s({},u({type:"Bls12381G1Key2020",publicKeyBase58:i.encode(r.slice(2))}),{id:"#"+e,controller:"did:key:"+e})};if(235===r[0]&&1===r[1])return{bls12381G2KeyPair:s({},u({type:"Bls12381G2Key2020",publicKeyBase58:i.encode(r.slice(2))}),{id:"#"+e,controller:"did:key:"+e})};if(238===r[0]&&1===r[1]){var t=u({type:"Bls12381G1Key2020",publicKeyBase58:i.encode(r.slice(2,50))}),n=u({type:"Bls12381G2Key2020",publicKeyBase58:i.encode(r.slice(50))});return{bls12381G1KeyPair:s({},t,{id:"#"+e,controller:"did:key:"+e}),bls12381G2KeyPair:s({},n,{id:"#"+e,controller:"did:key:"+e})}}throw new Error("unsupported fingerprint is not g1, g2 or g1 and g2.")},d=((l={})[r.G1]=234,l[r.G2]=235,l),p=function(e){var r=n.toBuffer(e.x),t=new Uint8Array(2+r.length);return t[0]=d[e.crv],t[1]=1,t.set(r,2),"did:key:z"+i.encode(t)},f=function(){function e(e){if(this.type="Bls12381G1Key2020",this.id=e.id,this.controller=e.controller,this.publicKeyBuffer=e.publicKeyBuffer,this.privateKeyBuffer=e.privateKeyBuffer,!this.controller){var r=this.toJsonWebKeyPair(!1);this.controller=p(r.publicKeyJwk)}if(!this.id){var i=this.toJsonWebKeyPair(!1);this.id="#"+p(i.publicKeyJwk).split("did:key:").pop()}}e.generate=function(){try{return Promise.resolve(c()).then((function(r){var t=r.bls12381G1KeyPair,n=u(t);return t.controller=p(n.publicKeyJwk),t.id="#"+t.controller.split("did:key:").pop(),new e({id:t.id,controller:t.controller,publicKeyBuffer:i.decode(t.publicKeyBase58),privateKeyBuffer:i.decode(t.privateKeyBase58)})}))}catch(e){return Promise.reject(e)}},e.fromFingerprint=function(r){var i=r.fingerprint;try{var t=y(i).bls12381G1KeyPair;return Promise.resolve(new e({id:t.id,controller:t.controller,publicKeyBuffer:n.toBuffer(t.publicKeyJwk.x)}))}catch(e){return Promise.reject(e)}},e.from=function(r){try{if("JsonWebKey2020"===r.type){var t={id:r.id,controller:r.controller,publicKeyBuffer:n.toBuffer(r.publicKeyJwk.x)};return r.privateKeyJwk&&(t.privateKeyBuffer=n.toBuffer(r.privateKeyJwk.d)),Promise.resolve(new e(t))}if("Bls12381G1Key2020"===r.type){var o={id:r.id,controller:r.controller,publicKeyBuffer:i.decode(r.publicKeyBase58)};return r.privateKeyBase58&&(o.privateKeyBuffer=i.decode(r.privateKeyBase58)),Promise.resolve(new e(o))}throw new Error("unsuported key type")}catch(e){return Promise.reject(e)}};var r=e.prototype;return r.fingerprint=function(){var e=this.toJsonWebKeyPair(!1);return p(e.publicKeyJwk).split("did:key:").pop()},r.toKeyPair=function(e){void 0===e&&(e=!1);var r={id:this.id,type:this.type,controller:this.controller,publicKeyBase58:i.encode(this.publicKeyBuffer)};return e&&(r.privateKeyBase58=i.encode(this.privateKeyBuffer)),r},r.toJsonWebKeyPair=function(e){return void 0===e&&(e=!1),u(this.toKeyPair(e))},r.verifier=function(){return new o.Bls12381G1KeyPair({publicKeyBase58:i.encode(this.publicKeyBuffer)}).verifier()},r.signer=function(){return new o.Bls12381G1KeyPair({publicKeyBase58:i.encode(this.publicKeyBuffer),privateKeyBase58:i.encode(this.privateKeyBuffer)}).signer()},e}(),K=function(){function e(e){if(this.type="Bls12381G2Key2020",this.id=e.id,this.controller=e.controller,this.publicKeyBuffer=e.publicKeyBuffer,this.privateKeyBuffer=e.privateKeyBuffer,!this.controller){var r=this.toJsonWebKeyPair(!1);this.controller=p(r.publicKeyJwk)}if(!this.id){var i=this.toJsonWebKeyPair(!1);this.id="#"+p(i.publicKeyJwk).split("did:key:").pop()}}e.generate=function(){try{return Promise.resolve(c()).then((function(r){var t=r.bls12381G2KeyPair,n=u(t);return t.controller=p(n.publicKeyJwk),t.id="#"+t.controller.split("did:key:").pop(),new e({id:t.id,controller:t.controller,publicKeyBuffer:i.decode(t.publicKeyBase58),privateKeyBuffer:i.decode(t.privateKeyBase58)})}))}catch(e){return Promise.reject(e)}},e.fromFingerprint=function(r){var i=r.fingerprint;try{var t=y(i).bls12381G2KeyPair;return Promise.resolve(new e({id:t.id,controller:t.controller,publicKeyBuffer:n.toBuffer(t.publicKeyJwk.x)}))}catch(e){return Promise.reject(e)}},e.from=function(r){try{if("JsonWebKey2020"===r.type){var t={id:r.id,controller:r.controller,publicKeyBuffer:n.toBuffer(r.publicKeyJwk.x)};return r.privateKeyJwk&&(t.privateKeyBuffer=n.toBuffer(r.privateKeyJwk.d)),Promise.resolve(new e(t))}if("Bls12381G2Key2020"===r.type){var o={id:r.id,controller:r.controller,publicKeyBuffer:i.decode(r.publicKeyBase58)};return r.privateKeyBase58&&(o.privateKeyBuffer=i.decode(r.privateKeyBase58)),Promise.resolve(new e(o))}throw new Error("unsuported key type")}catch(e){return Promise.reject(e)}};var r=e.prototype;return r.fingerprint=function(){var e=this.toJsonWebKeyPair(!1);return p(e.publicKeyJwk).split("did:key:").pop()},r.toKeyPair=function(e){void 0===e&&(e=!1);var r={id:this.id,type:this.type,controller:this.controller,publicKeyBase58:i.encode(this.publicKeyBuffer)};return e&&(r.privateKeyBase58=i.encode(this.privateKeyBuffer)),r},r.toJsonWebKeyPair=function(e){return void 0===e&&(e=!1),u(this.toKeyPair(e))},r.verifier=function(){return new o.Bls12381G2KeyPair({publicKeyBase58:i.encode(this.publicKeyBuffer)}).verifier()},r.signer=function(){return new o.Bls12381G2KeyPair({publicKeyBase58:i.encode(this.publicKeyBuffer),privateKeyBase58:i.encode(this.privateKeyBuffer)}).signer()},e}(),v=function(){function e(e){this.type="Bls12381KeyPairs2020",this.id=e.id,this.controller=e.controller,this.g1KeyPair=e.g1KeyPair,this.g2KeyPair=e.g2KeyPair,this.id||(this.id="#"+this.fingerprint()),this.controller||(this.controller="did:key:"+this.fingerprint()),this.g1KeyPair.controller=this.controller,this.g2KeyPair.controller=this.controller}e.generate=function(){try{return Promise.resolve(c()).then((function(r){var t=r.bls12381G1KeyPair,n=r.bls12381G2KeyPair;return new e({id:"",controller:"",g1KeyPair:new f({id:t.id,publicKeyBuffer:i.decode(t.publicKeyBase58),privateKeyBuffer:i.decode(t.privateKeyBase58)}),g2KeyPair:new K({id:n.id,publicKeyBuffer:i.decode(n.publicKeyBase58),privateKeyBuffer:i.decode(n.privateKeyBase58)})})}))}catch(e){return Promise.reject(e)}},e.fromFingerprint=function(r){var i=r.fingerprint;try{var t=!1,n=function(e){if(t)return e;if(0===i.indexOf("z3t"))return f.fromFingerprint({fingerprint:i});if(0===i.indexOf("zUC"))return K.fromFingerprint({fingerprint:i});throw new Error("Bls12381KeyPairs only supports g1, g2 and g1 and g2 mulicodec fingerprints.")},o=function(){if(0===i.indexOf("z5Tc")){var r=y(i),n=r.bls12381G1KeyPair,o=r.bls12381G2KeyPair;delete n.id,delete o.id;var c="did:key:"+i;return n.controller=c,o.controller=c,t=!0,Promise.resolve(f.from(n)).then((function(r){return Promise.resolve(K.from(o)).then((function(t){return new e({id:"#"+i,controller:c,g1KeyPair:r,g2KeyPair:t})}))}))}}();return Promise.resolve(o&&o.then?o.then(n):n(o))}catch(e){return Promise.reject(e)}};var r=e.prototype;return r.fingerprint=function(){var e=Buffer.concat([this.g1KeyPair.publicKeyBuffer,this.g2KeyPair.publicKeyBuffer]),r=new Uint8Array(2+e.length);return r[0]=238,r[1]=1,r.set(e,2),"z"+i.encode(r)},r.export=function(e){return void 0===e&&(e=!1),{fingerprint:this.fingerprint(),g1:this.g1KeyPair.toJsonWebKeyPair(e),g2:this.g2KeyPair.toJsonWebKeyPair(e)}},e}(),h=function(e,r){switch(void 0===r&&(r="application/did+ld+json"),r){case"application/did+json":case"application/did+cbor":return e.toJsonWebKeyPair();case"application/did+ld+json":return e.toKeyPair()}throw new Error("This implementation of did:key for bls12381 does not support: "+r)},B=function(e){return function(r){var i=void 0===r?{}:r,t=i.did,n=i.url;try{if(!(t=t||n))throw new TypeError('"did" must be a string.');return Promise.resolve(e(t)).then((function(e){return e.didDocument}))}catch(e){return Promise.reject(e)}}},b=function(){return function(e,r){void 0===r&&(r={accept:"application/did+ld+json"});try{var i=e.split("#")[0].split("did:key:").pop();return Promise.resolve(v.fromFingerprint({fingerprint:i})).then((function(e){return Promise.resolve(function(e,r){void 0===r&&(r="application/did+ld+json");try{var i={verificationMethod:[]},t="did:key:"+e.fingerprint();if("Bls12381KeyPairs2020"===e.type){var n=h(e.g1KeyPair,r),o=h(e.g2KeyPair,r);i.verificationMethod.push(n),i.verificationMethod.push(o),i=s({},i,{authentication:[n.id,o.id],assertionMethod:[n.id,o.id],capabilityInvocation:[n.id,o.id],capabilityDelegation:[n.id,o.id]})}else{var c=h(e,r);i.verificationMethod.push(c),i=s({},i,{authentication:[c.id],assertionMethod:[c.id],capabilityInvocation:[c.id],capabilityDelegation:[c.id]})}var l=s({"@context":["https://www.w3.org/ns/did/v1","https://ns.did.ai/transmute/v1",{"@base":t}],id:t},i);return Promise.resolve(l)}catch(e){return Promise.reject(e)}}(e,r.accept)).then((function(e){return{"@context":"https://w3id.org/did-resolution/v1",didDocument:e,didDocumentMetadata:{"content-type":r.accept},didResolutionMetadata:{}}}))}))}catch(e){return Promise.reject(e)}}},P=b(),g={__proto__:null,getGet:B,getResolve:b,resolve:P,get:B(P)};exports.Bls12381G1KeyPair=f,exports.Bls12381G2KeyPair=K,exports.Bls12381KeyPairs=v,exports.driver=g;
//# sourceMappingURL=did-key-bls12381.cjs.production.min.js.map
