"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var r=e(require("crypto")),t=e(require("canonicalize")),n=e(require("base64url")),i=require("bs58"),o=require("node-webcrypto-ossl");function u(){return(u=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}var c,f=function(e){var i=r.createHash("sha256").update(t({crv:e.crv,x:e.x,y:e.y,kty:e.kty})).digest();return n.encode(Buffer.from(i))},s=function(e){var r=i.decode(e),t={crv:"P-384",x:n.encode(r.slice(0,48)),y:n.encode(r.slice(48,96)),kty:"EC"};return u({},t,{kid:f(t)})},y=function(e,r){return u({},s(r),{d:n.encode(i.decode(e))})},a={__proto__:null,getKid:f,publicKeyJwkToPublicKeyBase58:function(e){var r=Buffer.concat([n.toBuffer(e.x),n.toBuffer(e.y)]);return i.encode(r)},publicKeyBase58toPublicKeyJwk:s,privateKeyJwkToPrivateKeyBase58:function(e){return i.encode(n.toBuffer(e.d))},privateKeyBase58toPrivateKeyJwk:y};c="object"==typeof process&&"object"==typeof process.versions&&void 0!==process.versions.node?new o.Crypto:window.crypto;var l=function(e,r){try{return Promise.resolve(c.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:"P-384"},!0,["sign"])).then((function(r){return Promise.resolve(c.subtle.sign({name:"ECDSA",hash:{name:"SHA-384"}},r,e)).then((function(e){return new Uint8Array(e)}))}))}catch(e){return Promise.reject(e)}},p=function(e,r,t){try{return Promise.resolve(c.subtle.importKey("jwk",t,{name:"ECDSA",namedCurve:"P-384"},!0,["verify"])).then((function(t){return c.subtle.verify({name:"ECDSA",hash:{name:"SHA-384"}},t,r,e)}))}catch(e){return Promise.reject(e)}},d={__proto__:null,sign:function(e,r,t){void 0===t&&(t={alg:"ES384"});try{var i=n.encode(JSON.stringify(t))+"."+n.encode(JSON.stringify(r));return Promise.resolve(l(new Uint8Array(Buffer.from(i)),e)).then((function(e){return i+"."+n.encode(Buffer.from(e))}))}catch(e){return Promise.reject(e)}},verify:function(e,r){try{var t=r.split("."),i=t[2],o=[t[0],t[1]].join(".");return Promise.resolve(p(new Uint8Array(Buffer.from(o)),new Uint8Array(n.toBuffer(i)),e)).then((function(e){return e}))}catch(e){return Promise.reject(e)}},signDetached:function(e,r,t){void 0===t&&(t={alg:"ES384"});try{var i=n.encode(JSON.stringify(t)),o=Buffer.concat([Buffer.from(i+".","utf8"),Buffer.from(r.buffer,r.byteOffset,r.length)]);return Promise.resolve(l(new Uint8Array(o),e)).then((function(e){return i+".."+n.encode(Buffer.from(e))}))}catch(e){return Promise.reject(e)}},verifyDetached:function(e,r,t){try{var i=r.split(".."),o=i[1],u=Buffer.concat([Buffer.from(i[0]+".","utf8"),Buffer.from(t.buffer,t.byteOffset,t.length)]);return Promise.resolve(p(new Uint8Array(Buffer.from(u)),new Uint8Array(n.toBuffer(o)),e)).then((function(e){return e}))}catch(e){return Promise.reject(e)}}},v=function(){function e(r){this.type="JsonWebKey2020",this.id=r.id,this.controller=r.controller,this.type=r.type||"JsonWebKey2020",this.publicKeyBuffer=r.publicKeyBuffer,this.privateKeyBuffer=r.privateKeyBuffer,r.publicKeyBase58&&(this.publicKeyBuffer=i.decode(r.publicKeyBase58)),r.privateKeyBase58&&(this.privateKeyBuffer=i.decode(r.privateKeyBase58)),r.publicKeyJwk&&(this.publicKeyBuffer=Buffer.concat([n.toBuffer(r.publicKeyJwk.x),n.toBuffer(r.publicKeyJwk.y)])),r.privateKeyJwk&&(this.publicKeyBuffer=Buffer.concat([n.toBuffer(r.privateKeyJwk.x),n.toBuffer(r.privateKeyJwk.y)]),this.privateKeyBuffer=Buffer.concat([n.toBuffer(r.privateKeyJwk.d)]));var t=i.encode(this.publicKeyBuffer),o=e.fingerprintFromPublicKey({publicKeyBase58:t});this.id||(this.id="#"+o),this.controller||(this.controller="did:key:"+o)}e.fingerprintFromPublicKey=function(e){var r=i.decode(e.publicKeyBase58),t=new Uint8Array(2+r.length);return t[0]=239,t[1]=1,t.set(r,2),"z"+i.encode(t)},e.fromFingerprint=function(r){var t=r.fingerprint,n=i.decode(t.substr(1));if(239===n[0]&&1===n[1]){var o=i.encode(n.slice(2)),u="did:key:"+e.fingerprintFromPublicKey({publicKeyBase58:o}),c="#"+e.fingerprintFromPublicKey({publicKeyBase58:o});return new e({id:c,controller:u,publicKeyBase58:o})}throw new Error("Unsupported Fingerprint Type: "+t)};var r,t=e.prototype;return t.addEncodedPublicKey=function(e){return e.publicKeyBase58=i.encode(this.publicKeyBuffer),e},t.publicNode=function(e){var r=(void 0===e?{}:e).controller,t=void 0===r?this.controller:r,n={id:this.id,type:this.type};return t&&(n.controller=t),this.addEncodedPublicKey(n),n},t.toJwk=function(e){return void 0===e&&(e=!1),e?y(i.encode(this.privateKeyBuffer),i.encode(this.publicKeyBuffer)):s(i.encode(this.publicKeyBuffer))},t.toVerificationMethod=function(){var e=this.toJwk();return delete e.kid,{id:this.id,type:"JsonWebKey2020",controller:this.controller,publicKeyJwk:e}},t.fingerprint=function(){var r=i.encode(this.publicKeyBuffer);return e.fingerprintFromPublicKey({publicKeyBase58:r})},t.signer=function(){if(!this.privateKeyBuffer)return{sign:function(){try{throw new Error("No private key to sign with.")}catch(e){return Promise.reject(e)}}};var e=i.encode(this.privateKeyBuffer),r=i.encode(this.publicKeyBuffer),t=y(e,r);return{sign:function(e){var r=e.data;try{var n=l(r,t);return Promise.resolve(n)}catch(e){return Promise.reject(e)}}}},t.verifier=function(){if(!this.publicKeyBuffer)return{verify:function(){try{throw new Error("No public key to verify with.")}catch(e){return Promise.reject(e)}}};var e=i.encode(this.publicKeyBuffer),r=s(e);return{verify:function(e){var t=e.data,n=e.signature;try{return Promise.resolve(p(t,n,r))}catch(e){return Promise.reject(e)}}}},t.deriveSecret=function(e){var r=e.publicKey;try{var t=i.encode(this.privateKeyBuffer),n=i.encode(this.publicKeyBuffer),o=y(t,n);return Promise.resolve(function(e,r){try{return Promise.resolve(c.subtle.importKey("jwk",e,{name:"ECDH",namedCurve:"P-384"},!0,["deriveBits"])).then((function(e){return Promise.resolve(c.subtle.importKey("jwk",r,{name:"ECDH",namedCurve:"P-384"},!0,["deriveBits"])).then((function(r){return Promise.resolve(c.subtle.deriveBits({name:"ECDH",public:r},e,256)).then((function(e){return new Uint8Array(e)}))}))}))}catch(e){return Promise.reject(e)}}(o,r.publicKeyJwk))}catch(e){return Promise.reject(e)}},(r=[{key:"publicKey",get:function(){return i.encode(this.publicKeyBuffer)}},{key:"privateKey",get:function(){return i.encode(this.privateKeyBuffer)}}])&&function(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(e.prototype,r),e}();v.from=function(e){try{return Promise.resolve(new v(u({},e)))}catch(e){return Promise.reject(e)}},v.generate=function(){try{return Promise.resolve(function(){try{return Promise.resolve(c.subtle.generateKey({name:"ECDSA",namedCurve:"P-384"},!0,["sign","verify"])).then((function(e){return Promise.resolve(c.subtle.exportKey("jwk",e.publicKey)).then((function(r){return Promise.resolve(c.subtle.exportKey("jwk",e.privateKey)).then((function(e){return{publicKeyJwk:r,privateKeyJwk:e}}))}))}))}catch(e){return Promise.reject(e)}}()).then((function(e){return v.from(e)}))}catch(e){return Promise.reject(e)}};var h=function(e){var r="did:key:"+e.fingerprint(),t=e.toJwk(),n="#"+t.kid;return delete t.kid,{"@context":["https://www.w3.org/ns/did/v1",{"@base":r}],id:r,publicKey:[{id:n,type:e.type,controller:r,publicKeyJwk:t}],authentication:[n],assertionMethod:[n],capabilityDelegation:[n],capabilityInvocation:[n],keyAgreement:[n]}},b={__proto__:null,computeKeyId:function(e){var r=e.key;try{return Promise.resolve("did:key:"+r.fingerprint()+"#"+r.fingerprint())}catch(e){return Promise.reject(e)}},keyToDidDoc:h,get:function(e){var r=void 0===e?{}:e,t=r.did,n=r.url;try{if(!(t=t||n))throw new TypeError('"did" must be a string.');var i=t.split("#")[0].split("did:key:").pop();return Promise.resolve(v.fromFingerprint({fingerprint:i})).then((function(e){return h(e)}))}catch(e){return Promise.reject(e)}}};exports.ES384=d,exports.P384KeyPair=v,exports.driver=b,exports.keyUtils=a;
//# sourceMappingURL=did-key-p384.cjs.production.min.js.map
